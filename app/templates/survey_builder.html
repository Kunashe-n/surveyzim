{% extends "layout.html" %}

{% block title %}Create Survey - SurveyZim{% endblock %}

{% block content %}
<div id="survey-builder">
    <div class="neu-card">
        <h2 class="page-title">
            <i class="fas fa-plus"></i> Create New Survey
        </h2>

        <!-- Word Count Information -->
        <div class="word-count-info">
            <i class="fas fa-info-circle"></i>
            Your current plan: <strong>{{ current_user.payment_status|capitalize if current_user.payment_status != 'unpaid' else 'Unpaid' }}</strong>
            {% if current_user.payment_status != 'unpaid' %}
                (Max {{ current_user.word_limit }} words)
            {% else %}
                (Purchase a plan to publish surveys)
            {% endif %}
            <div class="word-count-display">
                <span id="total-word-count">0</span> / 
                <span id="word-limit">
                    {% if current_user.payment_status != 'unpaid' %}
                        {{ current_user.word_limit }}
                    {% else %}
                        âˆž
                    {% endif %}
                </span> words
            </div>
            {% if current_user.payment_status == 'unpaid' %}
            <div class="word-limit-info">
                <i class="fas fa-exclamation-circle"></i>
                You need to purchase a plan to publish surveys.
            </div>
            {% endif %}
        </div>

        <form method="POST" id="survey-form">
            {{ form.hidden_tag() }}

            <!-- Survey Title -->
            <div class="form-group">
                {{ form.title.label }}
                {{ form.title(class="neu-input", placeholder="Enter survey title", id="survey-title") }}
                <div class="character-count">
                    <span id="title-word-count">0</span> words in title
                </div>
            </div>

            <!-- Survey Description -->
            <div class="form-group">
                {{ form.description.label }}
                {{ form.description(class="neu-input", placeholder="Enter survey description", rows="4", id="survey-description") }}
                <div class="character-count">
                    <span id="description-word-count">0</span> words in description
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questions-container"></div>

            <!-- Add Question Button -->
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" id="add-question" class="neu-btn neu-btn-primary">
                    <i class="fas fa-plus"></i> Add Question
                </button>
            </div>

            <!-- Submit & Cancel -->
            <div class="form-actions" style="margin-top: 30px;">
                <a href="{{ url_for('main.dashboard') }}" class="neu-btn">
                    <i class="fas fa-arrow-left"></i> Cancel
                </a>
                <button type="submit" class="neu-btn neu-btn-primary" id="submit-btn">
                    <i class="fas fa-save"></i> Create Survey
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Store server-side data for JavaScript -->
<div id="server-data" 
     data-word-limit="{{ current_user.word_limit if current_user.payment_status != 'unpaid' else 999999 }}"
     data-has-paid-plan="{{ 'true' if current_user.payment_status != 'unpaid' else 'false' }}"
     style="display: none;">
</div>

<style>
    /* CSS styles remain the same as before */
    #survey-builder {
        max-width: 900px;
        margin: 40px auto;
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .word-count-info {
        background: rgba(76, 175, 80, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .word-count-display {
        font-weight: bold;
        font-size: 18px;
        color: var(--primary);
    }
    
    .word-limit-info {
        color: var(--danger);
        font-weight: bold;
        padding: 10px;
        background: rgba(244, 67, 54, 0.1);
        border-radius: 5px;
    }
    
    .character-count {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }

    .question-item {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        padding: 20px 25px;
        transition: box-shadow 0.2s;
        margin-bottom: 20px;
    }

    .question-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .option-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .required-toggle {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
    }

    .add-option {
        margin-top: 10px;
    }
    
    .question-word-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
</style>

<script>
// Get server-side data from hidden element
const serverData = document.getElementById('server-data');
const userWordLimit = parseInt(serverData.dataset.wordLimit);
const hasPaidPlan = serverData.dataset.hasPaidPlan === 'true';

let questionCount = 0;
let totalWordCount = 0;

function countWords(text) {
    if (!text || !text.trim()) return 0;
    return text.trim().split(/\s+/).length;
}

function updateTotalWordCount() {
    const titleWords = countWords(document.getElementById('survey-title').value);
    const descriptionWords = countWords(document.getElementById('survey-description').value);
    
    // Add words from all questions
    let questionWords = 0;
    document.querySelectorAll('.question-text-input').forEach(input => {
        questionWords += countWords(input.value);
    });
    
    totalWordCount = titleWords + descriptionWords + questionWords;
    
    // Update displays
    document.getElementById('title-word-count').textContent = titleWords;
    document.getElementById('description-word-count').textContent = descriptionWords;
    document.getElementById('total-word-count').textContent = totalWordCount;
    
    // Update styling based on word count
    const totalWordCountElement = document.getElementById('total-word-count');
    const submitBtn = document.getElementById('submit-btn');
    
    if (hasPaidPlan && totalWordCount > userWordLimit) {
        totalWordCountElement.style.color = 'var(--danger)';
        submitBtn.disabled = true;
        submitBtn.title = 'Word limit exceeded. Please upgrade your plan or reduce content.';
    } else {
        totalWordCountElement.style.color = '';
        submitBtn.disabled = false;
        submitBtn.title = '';
    }
}

function createQuestionBlock() {
    questionCount++;
    const container = document.getElementById("questions-container");

    const qDiv = document.createElement("div");
    qDiv.className = "neu-card question-item";
    qDiv.dataset.index = questionCount;

    qDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label><strong>Question ${questionCount}</strong></label>
            <button type="button" class="neu-btn neu-btn-danger delete-question">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="form-group">
            <input type="text" name="question_text[]" class="neu-input question-text-input" placeholder="Enter your question" required>
            <div class="question-word-count">
                <span class="question-word-count-value">0</span> words in this question
            </div>
        </div>
        <div class="form-group">
            <select name="question_type[]" class="neu-input question-type">
                <option value="short">Short answer</option>
                <option value="paragraph">Paragraph</option>
                <option value="multiple_choice">Multiple choice</option>
                <option value="checkbox">Checkboxes</option>
                <option value="dropdown">Dropdown</option>
            </select>
        </div>
        <div class="options-container" style="display:none;">
            <div class="option-list"></div>
            <button type="button" class="add-option neu-btn neu-btn-secondary">
                <i class="fas fa-plus"></i> Add Option
            </button>
        </div>
        <div class="required-toggle">
            <input type="checkbox" name="required_${questionCount}"> Required
        </div>
    `;
    container.appendChild(qDiv);

    const typeSelect = qDiv.querySelector(".question-type");
    const optionsContainer = qDiv.querySelector(".options-container");
    const optionList = qDiv.querySelector(".option-list");
    const questionInput = qDiv.querySelector(".question-text-input");
    const questionWordCount = qDiv.querySelector(".question-word-count-value");

    // Update word count when question text changes
    questionInput.addEventListener("input", function() {
        const words = countWords(this.value);
        questionWordCount.textContent = words;
        updateTotalWordCount();
    });

    // Show options only for multiple choice, checkbox, dropdown
    typeSelect.addEventListener("change", () => {
        if (["multiple_choice","checkbox","dropdown"].includes(typeSelect.value)) {
            optionsContainer.style.display = "block";
        } else {
            optionsContainer.style.display = "none";
            optionList.innerHTML = "";
        }
    });

    // Add option
    qDiv.querySelector(".add-option").addEventListener("click", () => {
        const index = qDiv.dataset.index;
        const optionCount = optionList.children.length + 1;

        const optionDiv = document.createElement("div");
        optionDiv.className = "option-item";

        if (typeSelect.value === "checkbox") {
            optionDiv.innerHTML = `<input type="checkbox" name="question_option_${index}[]" value="Option ${optionCount}"> <input type="text" name="question_option_${index}[]" placeholder="Option ${optionCount}" class="neu-input">`;
        } else if (typeSelect.value === "multiple_choice" || typeSelect.value === "dropdown") {
            optionDiv.innerHTML = `<input type="radio" name="question_option_radio_${index}" value="Option ${optionCount}"> <input type="text" name="question_option_${index}[]" placeholder="Option ${optionCount}" class="neu-input">`;
        }

        optionList.appendChild(optionDiv);
    });

    // Delete question
    qDiv.querySelector(".delete-question").addEventListener("click", () => {
        container.removeChild(qDiv);
        updateQuestionLabels();
        updateTotalWordCount();
    });
}

// Update question labels after deletion
function updateQuestionLabels() {
    const questions = document.querySelectorAll("#questions-container .question-item");
    questions.forEach((q, idx) => {
        q.querySelector("label strong").textContent = `Question ${idx + 1}`;
        q.dataset.index = idx + 1;
    });
    questionCount = questions.length;
}

// Add new question
document.getElementById("add-question").addEventListener("click", createQuestionBlock);

// Add event listeners to title and description inputs
document.getElementById('survey-title').addEventListener('input', updateTotalWordCount);
document.getElementById('survey-description').addEventListener('input', updateTotalWordCount);

// Initial update
updateTotalWordCount();
</script>
{% endblock %}